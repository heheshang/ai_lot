# AI-LOT 量化交易系统需求文档

## 1. 项目概述

### 1.1 项目背景
AI-LOT 是一个**本地优先**的量化交易桌面应用，支持策略开发、回测、实盘交易全流程管理。

### 1.2 核心价值
| 价值 | 说明 |
|------|------|
| **安全** | API密钥本地加密存储，不上传服务器 |
| **低延迟** | 本地执行策略，直连交易所 |
| **跨平台** | 支持 Windows / macOS / Linux |
| **开源友好** | 策略代码自主可控 |

### 1.3 用户角色

| 角色 | 典型用户 | 核心诉求 |
|------|----------|----------|
| **策略开发者** | 个人量化交易者 | 编写策略、回测验证 |
| **交易员** | 交易执行人员 | 监控策略、手动干预 |
| **管理员** | 团队负责人 | 用户管理、权限分配 |
| **审计员** | 合规人员 | 查看日志、生成报告 |

---

## 2. 功能需求

### 2.1 功能模块全景

```
┌─────────────────────────────────────────────────────────────────┐
│                        功能模块全景                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  用户管理   │  │  行情数据   │  │  策略开发   │  │  回测引擎   │
│  • 登录注册 │  │  • 实时行情 │  │  • 代码编辑 │  │  • 历史回放 │
│  • 权限控制 │  │  • K线图表  │  │  • 参数配置 │  │  • 性能指标 │
│  • 操作审计 │  │  • 深度数据 │  │  • 版本管理 │  │  • 参数优化 │
└─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘
       │                │                │                │
       └────────────────┼────────────────┼────────────────┘
                        ▼                ▼
                ┌─────────────┐  ┌─────────────┐
                │  实盘交易   │  │  风控管理   │
                │  • 订单管理 │  │  • 规则配置 │
                │  • 持仓监控 │  │  • 实时监控 │
                │  • 策略运行 │  │  • 预警通知 │
                └─────────────┘  └─────────────┘
```

### 2.2 核心业务流程

```
┌────────────────────────────────────────────────────────────────┐
│                       完整交易流程                             │
└────────────────────────────────────────────────────────────────┘

   用户登录
      │
      ▼
  ┌─────────┐     ┌─────────────┐     ┌─────────────┐
  │ 配置交易所 │────▶│ 编写/导入策略 │────▶│   回测验证   │
  │ (API密钥)  │     │ (JavaScript)  │     │ (历史数据)   │
  └─────────┘     └─────────────┘     └──────┬──────┘
                                              │ 通过
                                              ▼
                                       ┌─────────────┐
                                       │ 部署实盘运行  │
                                       │ (订阅实时行情)│
                                       └──────┬──────┘
                                              │
                                              ▼
                                       ┌─────────────┐
                                       │   监控管理   │
                                       │ • 持仓盈亏   │
                                       │ • 风控预警   │
                                       │ • 手动干预   │
                                       └─────────────┘
```

### 2.3 功能详细说明

#### 2.3.1 用户与权限

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 用户注册/登录 | 本地账户，可选云端同步 | P0 |
| 角色管理 | 管理员、开发者、交易员、审计员 | P0 |
| 权限控制 | 基于角色的访问控制（RBAC） | P1 |
| 操作审计 | 记录所有关键操作 | P1 |

**数据可见性规则**：

```
管理员: 可见所有用户的数据
开发者: 仅可见自己创建的策略和回测结果
交易员: 可见被分配的策略，以及所有订单/持仓
审计员: 可见所有审计日志和交易数据（只读）
```

#### 2.3.2 行情数据

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 交易所连接 | 支持 Binance / OKX / Bybit | P0 |
| 实时行情 | WebSocket 推送 | P0 |
| K线图表 | 多周期 K 线（1m ~ 1d） | P0 |
| 深度数据 | 订单簿深度 | P1 |
| 技术指标 | MA / MACD / RSI / BOLL 等 | P1 |

**数据流向**：
```
交易所 WebSocket → MarketClient → EventBus → Frontend + StrategyEngine
                                           ↓
                                      SQLite (缓存)
```

#### 2.3.3 策略开发

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 策略编辑器 | Monaco Editor，语法高亮 | P0 |
| 策略语言 | JavaScript / TypeScript | P0 |
| 参数配置 | 可配置参数，类型检查 | P0 |
| 策略模板 | 提供常用策略模板 | P1 |
| 版本管理 | Git 集成或内置版本 | P2 |

**策略脚本接口**：
```javascript
// 策略回调函数
function onInit() {
  // 策略初始化
}

function onBar(kline) {
  // K线更新时调用
  // 返回交易信号或 null
  return {
    action: 'buy',  // 或 'sell', 'close'
    quantity: 0.1,
    price: kline.close
  };
}

function onStop() {
  // 策略停止时调用
}
```

#### 2.3.4 回测引擎

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 历史回放 | 基于历史K线模拟交易 | P0 |
| 性能指标 | 夏普比率、最大回撤、年化收益 | P0 |
| 回测报告 | 图表化展示结果 | P0 |
| 滑点模拟 | 支持滑点和手续费设置 | P1 |
| 参数优化 | 网格搜索优化参数 | P2 |

**回测流程**：
```
用户发起回测
  │
  ▼
加载历史数据 (SQLite)
  │
  ▼
逐根K线回放
  │
  ▼
执行策略逻辑
  │
  ▼
模拟成交 (SimulatedExchange)
  │
  ▼
记录交易 + 计算指标
  │
  ▼
生成报告
```

#### 2.3.5 实盘交易

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 策略部署 | 一键启动策略到实盘 | P0 |
| 订单管理 | 查询、撤单、批量操作 | P0 |
| 持仓监控 | 实时盈亏更新 | P0 |
| 手动交易 | 支持手动下单干预 | P1 |
| 多账户 | 支持多交易所多账户 | P2 |

**策略运行流程**：
```
启动策略实例
  │
  ▼
订阅实时行情 (WebSocket)
  │
  ▼
接收K线事件
  │
  ▼
执行策略逻辑
  │
  ▼
生成交易信号
  │
  ▼
风控检查
  │  通过则继续
  ▼
下单到交易所
  │
  ▼
更新持仓和盈亏
```

#### 2.3.6 风控管理

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 规则配置 | 仓位限制、止损止盈、回撤控制 | P1 |
| 实时监控 | 监控风险指标，超限预警 | P1 |
| 预警通知 | 钉钉/企微/邮件通知 | P1 |
| 紧急止损 | 一键平仓所有持仓 | P0 |

---

## 3. 权限与安全需求

### 3.1 角色与权限矩阵

| 功能模块 | 管理员 | 开发者 | 交易员 | 审计员 |
|----------|--------|--------|--------|--------|
| 用户管理 | ✓ | ✗ | ✗ | ✗ |
| 策略编写/编辑 | ✓ | ✓ | ✗ | ✗ |
| 策略回测 | ✓ | ✓ | ✗ | ✗ |
| 实盘交易（启动/停止） | ✓ | ✗ | ✓ | ✗ |
| 手动下单 | ✓ | ✗ | ✓ | ✗ |
| 风控规则配置 | ✓ | ✗ | ✗ | ✗ |
| 紧急止损 | ✓ | ✗ | ✓ | ✗ |
| 查看操作日志 | ✓ | ✗ | ✗ | ✓ |
| 查看交易数据 | 全部 | 自己的策略 | 全部 | 全部（只读） |

### 3.2 数据加密需求

| 数据类型 | 加密方式 | 存储位置 |
|----------|----------|----------|
| 用户密码 | argon2 (cost=12) | SQLite（哈希） |
| API密钥 | AES-256-GCM | SQLite（加密） |
| 策略代码 | AES-256-GCM（可选） | SQLite（加密） |
| 网络传输 | TLS 1.3 | HTTPS / WSS |

### 3.3 操作审计日志

**必须记录的操作**：

| 操作类型 | 记录内容 |
|----------|----------|
| 登录/登出 | 用户、时间、IP、设备 |
| 策略操作 | 创建/修改/删除，变更前后内容 |
| 交易操作 | 下单/撤单，订单详情 |
| 风控操作 | 规则变更，触发详情 |
| 系统配置 | API密钥配置等 |

---

## 4. 集成与扩展需求

### 4.1 消息通知

| 渠道 | 优先级 | 典型场景 |
|------|--------|----------|
| 钉钉 | P0 | 交易信号、风控预警 |
| 企业微信 | P0 | 交易信号、风控预警 |
| 邮件 | P1 | 日报、月报 |
| SMS | P2 | 紧急风控触发 |

### 4.2 多终端支持

| 终端 | 功能范围 | 计划 |
|------|----------|------|
| PC桌面端 | 全功能 | Phase 1 |
| Web端 | 查询+监控 | Phase 3 |
| 移动端H5 | 监控+预警 | Phase 4 |

### 4.3 开放API（未来）

- 行情数据 API
- 策略信号 API
- 账户数据 API
- 交易执行 API

---

## 5. 非功能性需求

### 5.1 性能要求

| 指标 | 要求 |
|------|------|
| 行情延迟 | <100ms |
| 订单响应 | <50ms |
| 回测速度 | 100万根K线/分钟 |
| 启动时间 | <3秒 |
| 内存占用 | <500MB（空闲） |

### 5.2 可靠性要求

| 指标 | 要求 |
|------|------|
| 断线重连 | 自动重连，恢复状态 |
| 异常恢复 | 崩溃后恢复策略状态 |
| 数据备份 | 自动备份到本地 |

### 5.3 兼容性要求

**操作系统**：
- Windows 10/11 (x64)
- macOS 11+ (Intel/Apple Silicon)
- Linux (Ubuntu 20.04+, Debian 11+)

**交易所**（Phase 1）：
- Binance (Spot/Futures)
- OKX (Spot/Futures)

---

## 6. 开发里程碑

### Phase 1: MVP（4周）

**目标**：实现核心交易闭环

- [ ] 用户登录/权限系统
- [ ] Binance 交易所连接
- [ ] 实时行情展示（K线图）
- [ ] 策略编辑器
- [ ] 简单回测功能
- [ ] 手动交易

### Phase 2: 策略引擎（3周）

**目标**：完善的策略开发和回测

- [ ] 完整回测引擎
- [ ] 回测报告（图表化）
- [ ] 策略参数优化
- [ ] 多交易所支持（OKX）

### Phase 3: 实盘交易（3周）

**目标**：策略实盘运行

- [ ] 策略实盘运行
- [ ] 订单管理系统
- [ ] 持仓管理
- [ ] 交易控制台

### Phase 4: 风控系统（2周）

**目标**：风险监控和预警

- [ ] 风控规则配置
- [ ] 实时风险监控
- [ ] 预警通知（钉钉/企微）
- [ ] 紧急止损功能

### Phase 5: 完善优化（2周）

**目标**：生产可用

- [ ] 性能优化
- [ ] 错误处理
- [ ] 单元测试
- [ ] 用户文档

---

## 7. 附录

### 7.1 术语表

| 术语 | 说明 |
|------|------|
| K线 | 记录一段时间内的开盘、最高、最低、收盘价 |
| 滑点 | 订单成交价格与预期价格的差异 |
| 回测 | 使用历史数据测试策略效果 |
| 夏普比率 | 衡量风险调整后收益的指标 |
| 最大回撤 | 历史上最大亏损幅度 |

### 7.2 参考文档

- [Binance API](https://binance-docs.github.io/apidocs/)
- [OKX API](https://www.okx.com/docs-v5/)
- [Tauri 文档](https://tauri.app/)
- [ECharts 文档](https://echarts.apache.org/)
